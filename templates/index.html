<head>
    <title>Air Quality</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^3"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@^2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col" align="center">
                <canvas id="pm25_history"></canvas>
            </div>
            <div class="col" align="center">
                <canvas id="pm10_history"></canvas>
            </div>
        </div>
    </div>
    <!-- <div class="chart-container" style="position: relative; height:40vh; width:80vw">
        <canvas id="pm25_history"></canvas>
    </div>
    <div class="chart-container" style="position: relative; height:40vh; width:80vw">
        <canvas id="pm10_history" width="200" height="200"></canvas>
    </div> -->

    <script>
        const pm25_chart = new Chart(document.getElementById("pm25_history"), {
            type: "line",
            responsive: true,
            data: {
                datasets: [{
                    data: [],
                    segment: {
                        borderColor: function(context) {
                            if(context.p1.parsed.y > 250) {
                                return "rgb(126, 0, 35)" // Hazardous
                            } else if(context.p1.parsed.y > 150) {
                                return "rgb(153, 0, 76)" // Very unhealthy
                            } else if(context.p1.parsed.y > 55) {
                                return "rgb(255, 0, 0)" // Unhealthy
                            } else if(context.p1.parsed.y > 35) {
                                return "rgb(255, 126, 0)" // Unhealthy for sensitive groups
                            } else if(context.p1.parsed.y > 12) {
                                return "rgb(255, 255, 0)" // Moderate
                            } else {
                                return "rgb(0, 228, 0)" // Good
                            }
                        }
                    },
                    spanGaps: true
                }]
            },
            options: {
                scales: {
                    x: {
                        type: "time",
                        // time: {
                        //     unit: 'minute'
                        // },
                        title: {
                            display: false,
                            text: "Date"
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: "PM 2.5 (μg/m³)"
                    }
                }
            }
        })

        const pm10_chart = new Chart(document.getElementById("pm10_history"), {
            type: "line",
            responsive: true,
            data: {
                datasets: [{
                    data: [],
                    segment: {
                        borderColor: function(context) {
                            if(context.p1.parsed.y > 300) {
                                return "rgb(126, 0, 35)" // Hazardous
                            } else if(context.p1.parsed.y > 200) {
                                return "rgb(153, 0, 76)" // Very unhealthy
                            } else if(context.p1.parsed.y > 150) {
                                return "rgb(255, 0, 0)" // Unhealthy
                            } else if(context.p1.parsed.y > 100) {
                                return "rgb(255, 126, 0)" // Unhealthy for sensitive groups
                            } else if(context.p1.parsed.y > 50) {
                                return "rgb(255, 255, 0)" // Moderate
                            } else {
                                return "rgb(0, 228, 0)" // Good
                            }
                        }
                    },
                    spanGaps: true
                }]
            },
            options: {
                scales: {
                    x: {
                        type: "time",
                        // time: {
                        //     unit: 'minute'
                        // },
                        title: {
                            display: false,
                            text: "Date"
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: "PM 10 (μg/m³)"
                    }
                }
            }
        })

        const update_rate = 30.0

        function update() {
            console.log("updating")

            fetch(location.protocol + "\/\/" + location.hostname + ":" + location.port + "/get_data")
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    
                    pm25_chart.data.datasets[0].data = []
                    for(let i = 0; i < data["pm25"].length; i++) {
                        pm25_chart.data.datasets[0].data.push({x: data["pm25"][i].timestamp, y: data["pm25"][i].value})
                    }

                    pm10_chart.data.datasets[0].data = []
                    for(let i = 0; i < data["pm10"].length; i++) {
                        pm10_chart.data.datasets[0].data.push({x: data["pm10"][i].timestamp, y: data["pm10"][i].value})
                    }

                    pm25_chart.update()
                    pm10_chart.update()
                })
                .catch(error => console.error("Failed to reach API: " + error))
        }

        setInterval(update, update_rate * 1000)
        update()

    </script>
</body>